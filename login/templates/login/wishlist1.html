{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chandran Electronics Wishlist</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <div class="site-title">
        <h1>Your Wishlist</h1>
    </div>
    <div class="product-container">
        {% if wishlist_items %}
            {% for item in wishlist_items %}
                <div class="product-card" id="wishlist-item-{{ item.id }}">
                    <a href="{% url 'product_detail' item.product.id %}">
                        {% if item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="product-image">
                        {% else %}
                            <img src="{% static 'images/default.jpg' %}" alt="No Image" class="product-image">
                        {% endif %}
                    </a>
                    <div class="product-title">
                        <a href="{% url 'product_detail' item.product.id %}">{{ item.product.name }}</a>
                    </div>
                    <div class="product-price">Price: â‚¹{{ item.product.price }}</div>
                    <form method="POST" action="{% url 'remove_from_wishlist' item.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-remove">Remove</button>
                    </form>
                    <button type="button" class="btn btn-add" onclick="moveToCart({{ item.product.id }}, {{ item.id }})">Move to Cart</button>
                </div>
            {% endfor %}
        {% else %}
            <p>Your wishlist is empty.</p>
        {% endif %}
    </div>
    <a href="{% url 'ecommerce' %}" class="btn">Back to Shop</a>
    <script>
function getCSRFToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === ('csrftoken=')) {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    return cookieValue;
}

function moveToCart(productId, wishlistItemId) {
    fetch(`/ajax/move_to_cart/${productId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update navbar counts if present
            if (document.querySelector('.cart-count')) {
                document.querySelector('.cart-count').textContent = data.cart_count;
            }
            if (document.querySelector('.wishlist-count')) {
                document.querySelector('.wishlist-count').textContent = data.wishlist_count;
            }
            // Remove the item from the wishlist DOM
            const itemDiv = document.getElementById('wishlist-item-' + wishlistItemId);
            if (itemDiv) itemDiv.remove();
        } else {
            alert(data.error || 'Error moving to cart');
        }
    });
}
</script>

</body>
</html>